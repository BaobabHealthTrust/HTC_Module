<html>
<head>
  <script>
      var cancelDestination = "/htcs?tab=report";
      var data = {};
      var selects = {};
      var spinner;
      var session_date = new Date();
      session_date.setYear("<%= @session_date.year%>");
      session_date.setMonth("<%= @session_date.month - 1%>");
      session_date.setDate("<%= @session_date.day%>");

  </script>

  <%= stylesheet_link_tag 'panel' %>
  <%= javascript_include_tag 'spin' %>
</head>
<body>

<%= form_tag losses_path do %>

    <fieldset>
      <legend></legend>
      <br/>
      <label for="id"> </label>
      <select id="id" name="id">
        <option></option>

      </select>
      <br/>
    </fieldset>
    <%= submit_tag "Finish" %>

<% end %>
</body>

<%= javascript_include_tag 'touchscreentoolkitV2/ts' %>
<%= javascript_include_tag 'custom_date' %>
<%= javascript_include_tag 'jquery-1.3.2.min' %>

<script>


    __$("row1").style.display = "none";
    __$("buttons").style.verticalAlign = "bottom";
    __$("buttons").style.width = "100%";
    __$("buttons").style.height = "100%";

    btnNext.style.width = "250px";

    btnCancel.style.width = "250px";

    var display = "inline-table";

    btnDivs = __$('buttons').children[0].children;

    btnDivs[1].style.display = "none";
    btnDivs[2].style.display = "none";

    btnDivs[0].style.display = "inline-table";
    btnDivs[3].style.display = "inline-table";

    btnDivs[3].style.cssFloat = "right";

    var dsp = document.createElement("div");
    dsp.id = "dsp";
    dsp.style.display = "table-cell";
    dsp.style.border = "0px solid #3465a4";
    dsp.style.overflow = "hidden";
    dsp.style.borderRadius = "10px";
    dsp.style.width = "70%";
    dsp.style.verticalAlign = "top";
    dsp.innerHTML = "&nbsp";

    __$('textForid').style.height = "100%";
    __$('textForid').style.width = "100%";
    __$('textForid').value = -1;
    __$("ul1").parentNode.style.display = "none";
    row.insertBefore(dsp, row.firstChild);
    __$("row0").parentNode.appendChild(__$('buttons'));

    function collision($div1, $div2) {

        var y1 = $div1.offset().top;
        var h1 = $div1.outerHeight();
        var b1 = y1 + h1;

        var y2 = $div2.offset().top;
        var h2 = $div2.outerHeight();
        var b2 = y2 + h2;

        if (b1 < y2 || y1 > b2) return false;
        return true;
    }

    jQuery("#row0").hide();
    jQuery("#dsp").css({
        position: "absolute",
        "z-index": "100",
        top: "1px",
        left: "5px",
        width: "99%",
        height: (0.90 * window.innerHeight) + "px"})

    __$("__content").style.border = "none";
    btnCancel.parentNode.parentNode.parentNode.style.backgroundColor = "grey";
    btnCancel.onmousedown = function () {
        window.location = cancelDestination;
    }
    buildTable();

    //checkYCollision();

    function checkYCollision() {

        if (collision(jQuery("#holder"), jQuery(btnCancel.parentNode.parentNode.parentNode))) {
            //adjust collision div heights
        }
    }

    function loadTableData() {

        var div = document.createElement("div");
        div.id = "spin";
        document.body.appendChild(div);
        var opts = {
            lines: 15, // The number of lines to draw
            length: 7, // The length of each line
            width: 4, // The line thickness
            radius: 10, // The radius of the inner circle
            corners: 1, // Corner roundness (0..1)
            rotate: 0, // The rotation offset
            color: '#000', // #rgb or #rrggbb
            speed: 1, // Rounds per second
            trail: 60, // Afterglow percentage
            shadow: false, // Whether to render a shadow
            hwaccel: false, // Whether to use hardware acceleration
            className: 'spinner', // The CSS class to assign to the spinner
            zIndex: 2e9, // The z-index (defaults to 2000000000)
            top: 25, // Top position relative to parent in px
            left: 25 // Left position relative to parent in px
        };
        var target = document.getElementById('spin');
        __$("content-table").innerHTML = "";
        spinner = new Spinner(opts).spin(target);

        jQuery.ajax(
                {
                    url: "ajax_stock_levels_report?year1=" + __$("year1").value + "&month1=" + __$("month1").value + "&day1=" + __$("day1").value +
                            "&year2=" + __$("year2").value + "&month2=" + __$("month2").value + "&day2=" + __$("day2").value +
                            "&kit_name=" + __$("kit_name-select").value,
                    success: function (result) {

                        result = JSON.parse(result);
                        populateTable(result);
                        spinner.stop();
                    }
                }
        )

    }

    function populateTable(hash) {
        console.log(hash)
        var dates = hash["dates"];
        var table = __$("content-table");
        table.innerHTML = "";

        for (var i = 0; i < dates.length; i++) {

            var lotNumbers = Object.keys(hash[dates[i]]);
            for (var l in lotNumbers) {
                var kitTypes = Object.keys(hash[dates[i]][lotNumbers[l]]);

                for (var k in kitTypes) {

                    var row = document.createElement("div");
                    row.className = "row data-row";
                    row.className += (i % 2 == 0 ? " even" : " odd");
                    row.id = "r_" + i;
                    table.appendChild(row);


                    var values = [dates[i],
                        kitTypes[k],
                        lotNumbers[l],
                        hash[dates[i]][lotNumbers[l]][kitTypes[k]]['receipts'],
                        hash[dates[i]][lotNumbers[l]][kitTypes[k]]['damages'],
                        hash[dates[i]][lotNumbers[l]][kitTypes[k]]['distribution'],
                        hash[dates[i]][lotNumbers[l]][kitTypes[k]]['remaining'],
                        hash[dates[i]][lotNumbers[l]][kitTypes[k]]['exp_date']];

                    for (var k in values) {

                        var td = document.createElement("div");
                        td.className = "td data-td";
                        try {
                            td.innerHTML = values[k] || (k == (values.length - 1) ? "N/A" : 0);
                        } catch (e) {
                            console.log(hash[dates[i]][lotNumbers[l]])
                        }
                        td.style.width = Math.ceil(jQuery(row).width() / values.length) + "px";
                        row.appendChild(td)
                    }
                }
            }
        }

        for (var i in hash["totals"]) {
            __$(i).innerHTML = hash["totals"][i] || 0;
        }

        var options2 = jQuery("#month2").find("option").show();

        if (session_date.getFullYear() == __$("year2").value) {
            for (var i in options2) {
                if (parseInt(options2[i].value) > (parseInt(session_date.getMonth()) + 1)) {
                    jQuery(options2[i]).hide();
                }
            }
        }
        resizeHeaders();
    }

    function resizeHeaders() {
        var dataRow = document.getElementsByClassName("data-row")[0];
        var dataTds = document.getElementsByClassName("data-td");
        __$("h-table").style.width = (jQuery(dataRow).width() + 20 ) + "px";
        __$("f-table").style.width = (jQuery(dataRow).width() + 20 ) + "px";

        var tops = document.getElementsByClassName("thd");
        var bottoms = document.getElementsByClassName("bhd");

        for (var i = 0; i < tops.length; i++) {

            jQuery(bottoms[i]).attr('style', ('width:' + jQuery(dataTds[i]).width() + 'px !important'));
            jQuery(tops[i]).attr('style', ('width:' + jQuery(dataTds[i]).width() + 'px !important'));
        }
    }

    function checkMonth() {

        if (session_date.getFullYear() == __$("year2").value) {

            var options = jQuery("#month2").find("option");
            for (var i in options) {
                try {
                    if (parseInt(options[i].value) == (parseInt(session_date.getMonth()) + 1) &&
                            parseInt(__$("month2").value) > parseInt(options[i].value)) {
                        options[i].selected = true;
                    }
                } catch (e) {
                }
            }
        }

        var dateA = new Date(__$("year1").value, __$("month1").value, __$("day1").value);
        var dateB = new Date(__$("year2").value, __$("month2").value, __$("day2").value);

        if (dateA > dateB) {
            __$("year1").value = __$("year2").value;
            __$("month1").value = __$("month2").value;
            __$("day1").value = __$("day2").value;
        }

        loadTableData();
    }

    function loadDates(select, day, month, year) {

        var lastDay = new Date(year, month, 0).getDate();

        if (select.options > 0) {
            for (i = select.options.length - 1; i >= 0; i--) {
                select.remove(i);
            }
        }
        var sett = false;
        for (var i = 1; i <= lastDay; i++) {
            var option = document.createElement("option");
            option.setAttribute("value", i);
            option.innerHTML = i < 10 ? ("0" + i) : i;
            select.appendChild(option);
            if ((parseInt(day) > 0 && parseInt(day) == i) || session_date.getDate() == i && !sett) {
                option.selected = true;
                sett = true;
            }
        }
    }

    function buildTable() {
        var topTable = document.createElement("div");
        topTable.className = "table top-table";
        dsp.appendChild(topTable);

        var row = document.createElement("div");
        row.className = "row top-row";
        row.style.width = "100%";
        topTable.appendChild(row);

        var td = document.createElement("div");
        td.className = "td top-td top-label";
        td.style.textAlign = "center";
        td.innerHTML = "";
        row.appendChild(td);

        var td = document.createElement("div");
        td.className = "td top-td top-label selects";
        td.style.textAlign = "center";
        td.innerHTML = "<%= @site_name%> HTC Stock Levels";
        row.appendChild(td);

        var row2 = document.createElement("div");
        row2.className = "row top-row";
        topTable.appendChild(row2);

        var td = document.createElement("div");
        td.className = "td top-td top-label";
        td.style.textAlign = "center";

        td.innerHTML = "<table class='selects' style='width: 100%;'><tr>" +
                "<td><label id ='kit_name-label'> Kit / Serum: </label></td> " +
                "<td> <select id ='kit_name-select'  onchange='loadTableData()'> </select></td>" +
                "</tr></table>"
        row2.appendChild(td);

        var td = document.createElement("div");
        td.style.width = "75%";
        td.className = "td top-td";
        td.style.textAlign = "center";

        td.innerHTML = "<table><tr><td><table class='selects' style='width: 100%;'><tr>" +

                "<td><label id ='date-label'> Start date: </label></td>" +
                "<td><select id ='day1' onchange='loadTableData()'></select>" +
                "<td><select id ='month1'  onchange='loadTableData()'></select> " +
                "</td><td><select id ='year1'  onchange='checkMonth()'> </select></td>  " +
                "<td></td></tr></table> </td><td>" +

                "<table class='selects' style='width: 100%;'><tr>" +

                "<td><label id ='date-label'> &nbsp;&nbsp;End date: </label></td>" +
                "<td><select id ='day2' onchange='loadTableData()'></select>" +
                "<td><select id ='month2'  onchange='loadTableData()'></select> " +
                "</td><td><select id ='year2'  onchange='checkMonth()'> </select></td>  " +
                "<td></td></tr></table></td></tr></table>"
        row2.appendChild(td);

        var kitSelect = __$("kit_name-select");

        var opt = document.createElement("option");
        opt.setAttribute("value", "");
        opt.innerHTML = "All";
        kitSelect.appendChild(opt);

        <% @kit_names.each_with_index do |kit, i|%>
        var opt = document.createElement("option");
        opt.setAttribute("value", "<%= kit%>");
        opt.innerHTML = "<%= kit%>";
        kitSelect.appendChild(opt);
        <% end %>

        var monthSelect = __$("month1");
        var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        for (var i in months) {
            var opt = document.createElement("option");
            opt.setAttribute("value", (parseInt(i) + 1));
            opt.innerHTML = months[i];
            if (months[i] == "<%=@start_month%>") {
                opt.selected = true;
            }
            monthSelect.appendChild(opt);
        }
        var monthSelect2 = __$("month2");
        for (var i in months) {
            var opt = document.createElement("option");
            opt.setAttribute("value", (parseInt(i) + 1));
            opt.innerHTML = months[i];
            if (months[i] == "<%=@cur_month%>") {
                opt.selected = true;
            }
            monthSelect2.appendChild(opt);
        }

        var yearSelect = __$("year1");
        <% @years.each do |year|%>
        var opt = document.createElement("option");
        opt.setAttribute("value", "<%= year%>");
        opt.innerHTML = "<%= year%>";
        <% if year == @cur_year%>
        opt.selected = true;
        <% end %>
        yearSelect.appendChild(opt);
        <% end %>

        var yearSelect2 = __$("year2");
        <% @years.each do |year|%>
        var opt = document.createElement("option");
        opt.setAttribute("value", "<%= year%>");
        opt.innerHTML = "<%= year%>";
        <% if year == @cur_year%>
        opt.selected = true;
        <% end %>
        yearSelect2.appendChild(opt);
        <% end %>

        loadDates(__$("day1"), "1", monthSelect.value, yearSelect.value);
        loadDates(__$("day2"), __$("day2").value, monthSelect2.value, yearSelect2.value);

        //Header for list items that come next
        var headerTable = document.createElement("div");
        headerTable.className = "table heada-table";
        headerTable.id = "h-table";

        var r = document.createElement("div");
        r.className = "row";
        headerTable.appendChild(r);

        var headers = ["Date", "Type", 'Lot number', 'Receipts', "Damages", "Distribution", "Remaining", 'Exp. date'];
        for (var i in headers) {
            var td = document.createElement("div");
            td.className = "td thd";
            td.innerHTML = headers[i];

            r.appendChild(td);
        }
        dsp.appendChild(headerTable);

        var dataHolder = document.createElement("div");
        dataHolder.id = "holder";
        dataHolder.style.height = 0.71 * jQuery(dsp).height() + "px";
        dataHolder.style.maxHeight = 0.71 * jQuery(dsp).height() + "px";

        var contentTable = document.createElement("div");
        contentTable.className = "table content-table";
        contentTable.id = "content-table";
        dataHolder.appendChild(contentTable);

        dsp.appendChild(dataHolder);

        var dataTable = document.createElement("div");
        dataTable.className = "table data-table";
        dataHolder.appendChild(dataTable);

        var footerTable = document.createElement("div");
        footerTable.className = "table heada-table";
        footerTable.id = "f-table";

        var r = document.createElement("div");
        r.className = "row";
        footerTable.appendChild(r);

        var headers = ["Total", "type", "lot_number", "receipts", "damages", "distribution", "remaining", "exp_date"];
        for (var i in headers) {
            var td = document.createElement("div");
            td.className = "td bhd";
            td.id = headers[i];
            td.innerHTML = "N/A";
            if (i == 0)
                td.innerHTML = headers[i];

            r.appendChild(td);
        }
        dsp.appendChild(footerTable);

        //load data in table
        loadTableData();
    }

</script>
</html>
<style>

    body {
        background: lightgray;
    }

    #buttons {
        position: absolute;
        top: 88.6%;
        height: 11% !important;
        left: 0.5%;
        width: 99% !important;
        border-radius: 7px !important;
    }

    * {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: -moz-none;
        -o-user-select: none;
        user-select: none;
    }

    #holder {
        background: lightgray !important;
        width: 98%;
        margin: auto;
        overflow: auto;
        margin-top: 3px;
        border-radius: 5px;
    }

    #content-table {
        background: white;
        border-radius: 10px !important;
    }

    #spin {
        position: absolute;
        top: 39%;
        left: 44.8%;
        z-index: 1000;
    }

    #dsp {
        margin-top: -1.3%;
        z-index: 80;
    }

    #buttons {
        z-index: 900;
    }

    .table {
        display: table;
        width: 99%;
        margin: auto;
        padding: 5px;
        padding-top: 0px;
        border-radius: 4px;
        background: lightblue;
    }

    .row {
        display: table-row;
        width: 100%;
        margin: auto
    }

    .td {
        display: table-cell;
        vertical-align: middle;
    }

    .top-table {
        border: 1px dotted #3465a4;
        text-shadow: #6374AB 2px 1px 2px;
    }

    .heada-table {
        margin-top: 1.2px;
        border: 1px dotted #3465a4;
        background: #ccc;
        border-top: none;
        vertical-align: middle;
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        padding-bottom: 0px;
        background-color: lightgray;
        text-shadow: #6374AB 2px 1px 2px;
    }

    #f-table {
        background: #ccc;
    }

    .heada-table .td {
        padding: 0px;
    }

    .top-label {
        font-size: 22px;
        font-weight: bold;
    }

    label {
        float: right;
        padding-left: 20px;
        font-size: 17.5px;
    }

    .selects {
        border: 1px dotted white;
        border-bottom: none;
        border-radius: 5px;
    }

    .selects1 {
        border: none;
        border-radius: 5px;
    }

    .thd, .bhd {
        border-radius: 4px;
        border: 0.5px dotted white;
        border-top: none;
        border-bottom: none;
    }

    .data-td {
        text-align: center;
        color: black;
        font-size: 17px;
        height: 27px;
        margin: 0px;
        padding: 0px;
    }

    .selects select, .selects1 select {
        min-width: 70px;
        width: 120px;
        height: 35px;
        padding: 0px;
        margin: 0px;
        background: lightgray;
        border-radius: 6px;
    }

    #day1, #day2 {
        min-width: 80px !important;
        width: 70px !important;
    }

    #month, #kit_name {
        float: right;
    }

    #year {
        float: left;
        width: 60px;
    }

    #kit_name-select {
        width: 190px;
    }

    #user-select {
        width: 200px;
    }

    #location-select {
        width: 170px;
    }

    select {
        font-size: 18px;
        color: black;
    }

    select option {
        font-size: 18px;
        padding: 10px;
        color: black;
        min-width: 100px;
    }

    .odd, .even {
        background: #cfe4cd !important;
    }

</style>
