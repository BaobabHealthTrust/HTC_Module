<html>
  <head>
    <style>
      #cover {
        display: none;
      }
    </style>
    <%= javascript_include_tag 'jquery-1.3.2.min' %>
		<%= javascript_include_tag 'custom' %>
    <script>

			var cancelDestination = addLink(window, <%=params[:id] %>)

      var rapidValue = "";
      var goldValue = "";
      var motherStatus = "";
      var testing = parseInt('<%= @testing %>')
      var kits = JSON.parse('<%= @kits.to_json.html_safe %>');
      var result1 = "";
      var result2 = "";

       function activateNext(){
        if (btnNext){
                        var pos = parseInt(btnNext.getAttribute("pos"));
                              console.log(pos);

                              if((pos == 1) && (__$("valid_rapid").value == "no" || __$("valid_gold").value == "no")){
                                         btnNext.onclick = function(){
                                          confirm("Enter correct lot numbers");
                                      };
                              }
                              else {
                                         btnNext.onclick = function(){

                                        var pos = parseInt(this.getAttribute("pos"))+ 1;

                                        var section = parseInt(this.getAttribute("section"));

                                        clearTimeout()

                                        navigateTo(pos, section);

                                      };
                              }
                         }
      }

      function checkLot() {
          if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp=new XMLHttpRequest();
          }else{// code for IE6, IE5
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
          }
          xmlhttp.onreadystatechange=function() {
              if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                  var results = xmlhttp.responseText;
                  if (eval(results) == "none"){
                      __$("valid_rapid").value = "no"
                  }
                  else {
                      __$("valid_rapid").value = "yes"
                  }
                  activateNext()
              }
          }
          if (currentPage == 0) {
              xmlhttp.open("GET", "/inventory/batch_available?lot_number=" + __$("rapid_lot").value + "&name=" + kits[0][1], true);
              xmlhttp.send();
          }
          setTimeout("checkLot()", 500);
      }

	function checkSecondLot() {
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
                        xmlhttp=new XMLHttpRequest();
                }else{// code for IE6, IE5
                        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
                }
                xmlhttp.onreadystatechange=function() {
                        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                          var results = xmlhttp.responseText;
													  if (eval(results.toUpperCase()) == 'NONE'){																
															__$("valid_gold").value = "no"	
														}else {
															__$("valid_gold").value = "yes"
														}
                                                                                                         activateNext()
                          }
                        }
        if (currentPage == 0) {
            xmlhttp.open("GET", "/inventory/batch_available?lot_number=" + __$("gold_lot").value + "&name=" + kits[1][1], true);
            xmlhttp.send();
        }
        setTimeout("checkSecondLot()", 500);
}

      function doLogin(id){

                            if(__$(id) && __$(id).value.trim().match(/\$/)){

                               __$(id).value =  __$(id).value.trim().replace(/\$/, "");

                                    clearTimeout(id)
                                      document.forms[0].submit();

                                    return;
                            }

                      setTimeout("doLogin('" + id + "')", 500);
            }

      function setValues(){
          var redRapidColor = false;
          var redGoldColor = false;
        if (__$('timetimer1')){
          rapidValue = __$('timetimer1').innerHTML.toString();
          redRapidColor =  (__$('timetimer1').style.color == 'red') ? true : false;
        }
        __$('rapidtimer').value = subtractMinutes(rapidValue.split(":"), "15:00".split(":"), redRapidColor);
        if(__$('timetimer2')){
          goldValue = __$('timetimer2').innerHTML.toString();
            redGoldColor =  (__$('timetimer2').style.color == 'red') ? true : false;
        }
        __$('goldtimer').value =  subtractMinutes(goldValue.split(":"), "10:00".split(":"), redGoldColor);
        __$("allresults").value  = "";
        if(__$("HTC Test 1 result").value == "Reactive" && __$("HTC Test 2 result").value == "Reactive"){
          __$("allresults").value = "Reactive"
          clearTimeout("setValues()")
         // confirm("HIV positive")
        }

        else if((__$("HTC Test 1 result").value == "Reactive" && __$("HTC Test 2 result").value == "Non-Reactive") || (__$("HTC Test 1 result").value == "Non-Reactive" && __$("HTC Test 2 result").value == "Reactive")){
          __$("allresults").value = "Inconclusive"
          clearTimeout("setValues()")
          //confirm("Inconclusive")
        }
        else {
          __$("allresults").value = "Inconclusive"
        }

        setTimeout("setValues()", 500);
      }

      function confirm(message){
        var ele = document.getElementById('cover')
        ele.style.display = "inline";
        ele.style.background = 'rgba(34,34,34,0.75)';
        document.body.appendChild(ele);
        var ele = document.getElementById('popup')
        ele.style.display = "inline";
        html = "<div style='display:table;width:100%;'><div style='display:table-row;width:100%;'>";
        html += "<div id='text'>" + message + "</div></div><div style='display:table-row;width:100%;'>";
        html += '<div style="display:table-cell;width:100%;"><div style="display:table;width:100%;"><div style="display:table-row;width:100%;">';
        if (message == "Enter correct lot numbers"|| message == 'Send DBS to HIV National Reference Lab'){
            html += '<div id="confirm"><button class="button red" style="margin: 3px; font-size: 20px; height: 60px;" onmousedown="reset()">Ok</button></div>';
        }
        else{
            html += '<div id="confirm"><button class="button blue" style="margin: 3px; font-size: 20px; height: 60px;" onmousedown="allow()">Ok</button></div>';
        }
        html += "</div></div></div></div></div>"
        ele.innerHTML =  html;
        document.body.appendChild(ele);
      }

      function reset(){
            ele = document.getElementById('cover')
            ele.style.display = "none";
            ele = document.getElementById('popup')
            ele.style.display = "none";
        }
              
      function __$(id){
        return document.getElementById(id);
      }

            function addData(parent){
                var tbl = document.createElement("div");
                tbl.style.display = "table";
                tbl.style.width = "100%";

                tbl.style.border = "1px solid #3465a4";
                tbl.style.borderRadius = "5px";

                parent.appendChild(tbl);

                attributes = [["Test 1", __$("HTC Test 1 result").value], ["Test 2", __$("HTC Test 2 result").value],["Risk Assessment", '<%= @message %>']]
                for (i = 0; i < attributes.length; i ++) {
                    row = document.createElement("div");
                    row.style.display = "table-row";
                    if (i % 2 == 0){
                        row.style.backgroundColor = '#C1CDCD';
                    }
                    else{
                        row.style.backgroundColor = '#FFF8DC';
                    }
                    tbl.appendChild(row);

                    var cell1 = document.createElement("div");
                    cell1.style.display = "table-cell";
                    cell1.style.textAlign = "left";
                    cell1.style.verticalAlign = "left";
                    cell1.style.fontSize = "25px";
                    cell1.innerHTML = attributes[i][0]
                    row.appendChild(cell1);

                    var cell2 = document.createElement("div");
                    cell2.style.display = "table-cell";
                    cell2.style.textAlign = "middle";
                    cell1.style.fontSize = "25px";
                    cell2.style.verticalAlign = "right";
                    cell2.innerHTML = attributes[i][1];
                    if( i == 2) {
                        if (__$("HTC Test 1 result").value == "Reactive" && __$("HTC Test 2 result").value == "Reactive") {
                            cell2.innerHTML = "Postive Results.<br /> Refer to ART Clinic for treatment.";
                        }
                        else {
                            cell2.innerHTML = "Inconclusive Results.<br /> <span style='color: darkred'><%= @message %></span>";
                        }
                    }
                    row.appendChild(cell2);
                }
            }


            function adjust(){
                node =  document.getElementById('row2').childNodes[0].childNodes[0];
                node.style.width = "6%";
                node.style.height = "92px";
                document.getElementById('row2').childNodes[0].style.height = "92px";
                document.getElementById('row2').style.height = "92px";
                document.getElementById('row2').childNodes[0].style.backgroundColor = "grey";
                document.getElementById('row2').childNodes[0].style.MozBorderRadius = '1em';
                document.getElementById('row2').childNodes[0].style.borderRadius = '1em';
                button =  document.getElementById('buttons');
                button.style.removeProperty('border')
                button.style.backgroundColor = "grey";
            }

            function createSummary(){
                __$("main-content-area").innerHTML = "";
                adjust()
                var node =  document.getElementById('row2').childNodes[0].childNodes[0];
                node.style.width = "100%";
                node.style.height = "92px";
                __$("stage").style.display = "none";
                __$("buttons").style.width = "100%";
                __$("buttons").style.height = "100%";

                btnDivs = __$('buttons').children[0].children;

                btnDivs[0].style.display = "none";
                btnDivs[1].style.display = "none";

                btnDivs[2].style.display  = "inline-table";
                btnDivs[3].style.display  = "inline-table";

                btnDivs[3].style.cssFloat = "right";


                var table = document.createElement("div");
                table.style.display = "table";
                table.style.margin = "auto";
                table.style.width = "100%";
                __$("main-content-area").appendChild(table);

                var row1 = document.createElement("div");
                row1.style.display = "table-row";
                row1.style.width = "100%"
                table.appendChild(row1);


                var cell1_1 = document.createElement("div");
                cell1_1.style.display = "table-cell";
                cell1_1.style.width = "90%"
                cell1_1.id = "testsummary";


                row1.appendChild(cell1_1);
                addData(cell1_1)
                btnDivs[3].innerHTML = "Finish"
                btnDivs[3].setAttribute("class", "button blue")
                btnDivs[3].onclick = function(){
                    document.forms[0].submit();
                }
            }

      function loadCustom(){

        if(__$("main-content-area")){

          __$("main-content-area").innerHTML = "";

          var table = document.createElement("div");
          table.style.display = "table";
          table.style.margin = "auto";
          __$("main-content-area").appendChild(table);

          var row1 = document.createElement("div");
          row1.style.display = "table-row";
          table.appendChild(row1);

          var cell1_1 = document.createElement("div");
          cell1_1.style.display = "table-cell";
          cell1_1.id = "timer1";
          row1.appendChild(cell1_1);

          cell1_1.setAttribute("targetID", 'rapidrange');
          var timer1 = addTimer(cell1_1, 15, " Test 1 Timer", 0.55)
          timer1.style.marginLeft = "40px";
          timer1.style.marginRight = "40px";

          var cell1_2 = document.createElement("div");
          cell1_2.style.display = "table-cell";
          cell1_2.id = "timer2";
          cell1_2.style.textAlign = "right";
          row1.appendChild(cell1_2);

          cell1_2.setAttribute("targetID", 'goldrange');
          var timer2 = addTimer(cell1_2, 10, " Test 2 Timer", 0.55);
          timer2.style.marginLeft = "40px";
          timer2.style.marginRight = "40px";

        }
      }
  function checkKits(){
     __$("gold_lot").value = "";
     __$("rapid_lot").value = "";
     __$("customresult1").value = "";
     __$("customresult2").value = "";
     reset();
      if (testing == 0){
                loadMessage('You do not have one of the test kits ',addLink(window, <%=params[:id] %>), 1500);
      }
  }
    function sendToDBS() {
        if (!(__$("HTC Test 1 result").value == "Reactive" && __$("HTC Test 2 result").value == "Reactive")) {
            confirm('Send DBS to HIV National Reference Lab');
        }
    }

    function updateServerTime(){
        now.setSeconds(now.getSeconds() + 1);
    }

    now = new Date(Date.parse('<%= Time.now.to_s(:db)%>'.replace('-','/','g')));
    var interval = window.setInterval('updateServerTime()', 1000);

    </script>
  </head>
  <body  onLoad="checkKits();setValues();checkLot();checkSecondLot();">

	<form action='/encounters/new/<%= params[:id] %>' method='post'>

      <input type="hidden" value="<%= form_authenticity_token() %>" name="authenticity_token"/>
      <input type="hidden" value="HIV TESTING" name="ENCOUNTER"/>

      <input type="hidden" value="" id="valid_rapid" name="test1 done"/>
      <input type="hidden" value="" id="valid_gold" name="test2 done"/>
      <input type="hidden" name="observations[][value_text]" id="allresults" />
      <input type="hidden" name="observations[][concept_name]" value="Result of hiv test" />
      <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
      <input type="hidden" name="observations[][obs_datetime]"  value="" />

      <input type="hidden" name="observations[][value_text]" id="goldname" value="<%= @kits[1][1] rescue ""  %>" />
      <input type="hidden" name="observations[][concept_name]" value="HTC Test 2 name" />
      <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
      <input type="hidden" name="observations[][obs_datetime]"  value="" />

      <input type="hidden" name="observations[][value_text]" id="rapidname" value="<%= @kits[0][1] rescue "" %>" />
      <input type="hidden" name="observations[][concept_name]" value="HTC Test 1 name" />
      <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
      <input type="hidden" name="observations[][obs_datetime]"  value="" />

        <fieldset>
        <legend>HIV Confirmatory Testing For <%= @client.name.split.map(&:capitalize).join(' ') %></legend>
            <label for="rapid_lot">(Test 1) <%= @kits[0][1] rescue ""  %> Lot Number</label>
            <input type='text' id="rapid_lot" name="observations[][value_text]" />
            <input name="observations[][concept_name]" type="hidden" value="rapid lot number" />
            <input name="observations[][patient_id]" type="hidden" value="<%= params[:id]%>" />
            <input name="observations[][obs_datetime]" type="hidden" value="" />


            <label for="gold_lot">(Test 2) <%= @kits[1][1] rescue ""  %> Lot Number</label>
            <input type='text' id="gold_lot" name="observations[][value_text]" />
            <input name="observations[][concept_name]" type="hidden" value="gold lot number" />
            <input name="observations[][patient_id]" type="hidden" value="<%= params[:id]%>" />
            <input name="observations[][obs_datetime]" type="hidden" value="" />

      </fieldset>

      <fieldset custom=true fs_onLoad="loadCustom();">
        <legend>HIV Confirmatory Testing For <%= @client.name.split.map(&:capitalize).join(' ') %></legend>


            <input id="customresult1" name="observations[][value_text]" type="hidden" value="" />
            <input type="hidden" name="observations[][concept_name]" value="HTC Test 1 result" />
            <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
            <input type="hidden" name="observations[][obs_datetime]" value="" />

            <input type="hidden" name="observations[][value_text]" id="rapidtimer" fieldtype="number" />
            <input type="hidden" name="observations[][concept_name]" value="HTC Test 1 Time frame" id="hidden"/>
            <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
            <input type="hidden" name="observations[][obs_datetime]" />
            <input type="hidden" name="observations[][value_complex]" id="rapidrange" />


            <input type="hidden" name="observations[][value_text]" id="goldtimer" fieldtype="number" />
            <input type="hidden" name="observations[][concept_name]" value="HTC Test 2 Time frame" />
            <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
            <input type="hidden" name="observations[][obs_datetime]" value="" />
            <input type="hidden" name="observations[][value_complex]" id="goldrange"/>


            <input id="customresult2" name="observations[][value_text]" type="hidden" value="" />
            <input type="hidden" name="observations[][concept_name]" value="HTC Test 2 result" />
            <input type="hidden" name="observations[][patient_id]" value="<%= params[:id] %>" />
            <input type="hidden" name="observations[][obs_datetime]" value="" />

      </fieldset>

      <fieldset>
        <legend>HIV Confirmatory Testing For <%= @client.name.split.map(&:capitalize).join(' ') %></legend>
        <% tests = ["HTC Test 1 result", "HTC Test 2 result"]
        results = [["Unknown","Unknown"],["Reactive","Reactive"],["Non-Reactive","Non-Reactive"]]
        tests.each { |test| %>
          <label for="<%= test %>"><%= test %></label>

          <select id="<%= test %>" class = "" name="observations[][value_coded_or_text]">
            <option></option>
            <% results.each {|result| %>
              <option value="<%= result[0] %>"><%= result[1] %></option>
            <% } %>
          </select>
          <%= hidden_field_tag("observations[][concept_name]",        test) %>
          <%= hidden_field_tag("observations[][patient_id]",         params[:id]) %>
          <%= hidden_field_tag("observations[][obs_datetime]",       "") %>
        <% } %>

        <label for="scan_accession_number" >Acknowledging Counselor Accession Number </label>

        <%= hidden_field_tag("observations[][concept_name]",        'Provider') %>
        <%= hidden_field_tag("observations[][patient_id]",         params[:id]) %>
        <%= hidden_field_tag("observations[][obs_datetime]",       "") %>
        <input type="text" id="scan_accession_number" name="observations[][value_coded_or_text]" optional="false" fieldtype="barcode" callback="doLogin('scan_accession_number')" />

      </fieldset>
      <fieldset custom=true fs_onLoad="sendToDBS();createSummary();">
        <legend>Summary (<%= @client.name.split.map(&:capitalize).join(' ') %>):</legend>
      </fieldset>
      <input type="submit" value="Submit" />

        </form>
  </body>
</html>
  <div id="cover" align="center">
  </div>
  <div id="popup" style="display:none">
  </div>
